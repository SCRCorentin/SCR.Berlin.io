<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Carte Clubs Berlin ‚Äî Itin√©raires</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <!-- LRM CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .topbar {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.95); border-radius: 10px; padding: 8px 10px; z-index: 1000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }
    .topbar b { font-size: 14px; }
    .leaflet-bar select { border: none; outline: none; padding: 4px; }
    .legend {
      position: absolute; bottom: 16px; left: 16px; z-index: 1000; background: rgba(255,255,255,0.95);
      padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.15); font-size: 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    /* Mobile tweaks */
    @media (max-width: 600px) {
      .topbar { left: 8px; right: 8px; transform: none; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topbar"><b>Carte Clubs Berlin</b> ‚Äî recherche üîç, itin√©raires üö∂üö≤üöó</div>
  <div class="legend">
    <b>Astuce</b><br/>
    ‚Ä¢ Cliquez pour d√©finir d√©part/arriv√©e<br/>
    ‚Ä¢ üîç chercher une adresse<br/>
    ‚Ä¢ ‚ùå effacer l'itin√©raire&nbsp;&nbsp;|&nbsp;&nbsp;‚Ü©Ô∏è annuler le dernier point<br/>
    ‚Ä¢ Menu en haut √† droite : lieux + mode
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <!-- LRM JS -->
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <!-- Geocoder JS -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // ---- Donn√©es ----
    const lieux = [
      { nom: "Crack Bellemer", lat: 52.5075992, lon: 13.4547859, desc: "ok pour groupes" },
      { nom: "Ritter Butzke", lat: 52.5028492, lon: 13.4078816, desc: "ok pour groupes" },
      { nom: "Berghain", lat: 52.5110691, lon: 13.4429945, desc: "Meilleure bo√Æte du monde (difficile d'entrer)" },
      { nom: "Renate", lat: 52.505, lon: 13.454, desc: "Club" },
      { nom: "Klunkerkranich", lat: 52.482195, lon: 13.4318525, desc: "Bar rooftop" },
      { nom: "Bulbul Berlin", lat: 52.4994098, lon: 13.4242594, desc: "Lieu festif" },
      { nom: "Golden Gate", lat: 52.5159496, lon: 13.4170683, desc: "Club (underground)" },
      { nom: "MS Hoppetosse", lat: 52.4975353, lon: 13.4546997, desc: "Club sur un bateau" },
      { nom: "Tr√©sor Berlin", lat: 52.5107462, lon: 13.4193396, desc: "Club techno l√©gendaire" },
      { nom: "SchwuZ", lat: 52.4794165, lon: 13.4337682, desc: "Club LGBTQ, facile √† entrer" }
    ];

    // ---- Carte ----
    const map = L.map('map').setView([52.5076, 13.4], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Marqueurs
    lieux.forEach(l => {
      L.marker([l.lat, l.lon], { title: l.nom })
        .addTo(map)
        .bindPopup(`<b>${l.nom}</b><br>${l.desc}`);
    });

    // Recherche adresse
    const geocoder = L.Control.geocoder({
      defaultMarkGeocode: true,
      placeholder: "Chercher une adresse‚Ä¶"
    }).addTo(map);

    // Localiser (n√©cessite https)
    L.control.locate = function(opts) {
      // Simple button that recenters to browser geolocation
      const control = L.control({position: 'topleft'});
      control.onAdd = function(){
        const div = L.DomUtil.create('div', 'leaflet-bar');
        const a = L.DomUtil.create('a', '', div);
        a.href = '#';
        a.title = 'Utiliser ma position';
        a.innerHTML = 'üìç';
        L.DomEvent.on(a, 'click', function(e){
          L.DomEvent.stop(e);
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
              const ll = [pos.coords.latitude, pos.coords.longitude];
              map.setView(ll, 15);
              L.circleMarker(ll).addTo(map).bindPopup('Vous √™tes ici').openPopup();
            });
          } else {
            alert('G√©olocalisation non support√©e par ce navigateur.');
          }
        });
        return div;
      };
      return control;
    };
    L.control.locate().addTo(map);

    // ---- Routing ----
    let currentProfile = 'foot'; // 'foot' | 'bike' | 'driving'
    const routerFactory = (profile) => L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1',
      profile
    });

    const formatter = new L.Routing.Formatter({ units: 'metric', language: 'fr' });

    const routingControl = L.Routing.control({
      router: routerFactory(currentProfile),
      routeWhileDragging: true,
      showAlternatives: true,
      collapsible: true,
      formatter,
      summaryTemplate: '<div><b>{name}</b><br><span id="lrm-mode">Mode: '+currentProfile+'</span><br>Distance: {distance}, Dur√©e: {time}</div>'
    }).addTo(map);

    function setProfile(profile){
      currentProfile = profile;
      routingControl.setRouter(routerFactory(currentProfile));
      const modeEl = document.getElementById('lrm-mode');
      if (modeEl) modeEl.textContent = 'Mode: ' + currentProfile;
      try { routingControl.route(); } catch(e) {}
    }

    // Clic pour poser d√©part/arriv√©e
    map.on('click', (e) => {
      const wps = routingControl.getWaypoints();
      if (!wps[0].latLng) {
        routingControl.setWaypoints([e.latlng]);
      } else if (!wps[1].latLng) {
        routingControl.setWaypoints([wps[0].latLng, e.latlng]);
      } else {
        // Si 2 points d√©j√† pos√©s, on remplace l'arriv√©e
        routingControl.setWaypoints([wps[0].latLng, e.latlng]);
      }
    });

    // ---- Contr√¥les additionnels ----
    // Clear (‚ùå) + Undo (‚Ü©Ô∏è)
    const clearCtrl = L.control({position: 'topleft'});
    clearCtrl.onAdd = function(){
      const div = L.DomUtil.create('div', 'leaflet-bar');
      const clearBtn = L.DomUtil.create('a', '', div);
      clearBtn.href = '#'; clearBtn.title = 'Supprimer tous les points'; clearBtn.innerHTML = '‚ùå';
      L.DomEvent.on(clearBtn, 'click', function(e){
        L.DomEvent.stop(e);
        routingControl.setWaypoints([]);
      });

      const undoBtn = L.DomUtil.create('a', '', div);
      undoBtn.href = '#'; undoBtn.title = 'Supprimer le dernier point'; undoBtn.innerHTML = '‚Ü©Ô∏è';
      L.DomEvent.on(undoBtn, 'click', function(e){
        L.DomEvent.stop(e);
        const wps = routingControl.getWaypoints();
        if (wps[1].latLng) {
          routingControl.setWaypoints([wps[0].latLng]);
        } else if (wps[0].latLng) {
          routingControl.setWaypoints([]);
        }
      });
      return div;
    };
    clearCtrl.addTo(map);

    // Menu "Itin√©raire vers :" + s√©lecteur de mode
    const quickCtrl = L.control({position: 'topright'});
    quickCtrl.onAdd = function(){
      const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
      container.style.background = 'white';
      container.style.padding = '6px';
      container.style.minWidth = '220px';

      const label = document.createElement('div');
      label.style.fontSize = '12px';
      label.style.marginBottom = '4px';
      label.innerHTML = '<b>Itin√©raire vers :</b>';
      container.appendChild(label);

      const sel = document.createElement('select');
      sel.style.width = '100%';
      sel.innerHTML = '<option value="">Choisir un lieu‚Ä¶</option>' +
        lieux.map(l => `<option value="${l.lat},${l.lon}">${l.nom}</option>`).join('');
      sel.onchange = function(){
        if (!sel.value) return;
        const [lat, lon] = sel.value.split(',').map(parseFloat);
        const dest = L.latLng(lat, lon);
        const wps = routingControl.getWaypoints();
        if (!wps[0].latLng) {
          routingControl.setWaypoints([map.getCenter(), dest]);
        } else {
          routingControl.setWaypoints([wps[0].latLng, dest]);
        }
      };
      container.appendChild(sel);

      const modeBox = document.createElement('div');
      modeBox.style.marginTop = '6px';
      modeBox.style.fontSize = '12px';
      modeBox.innerHTML = '<b>Mode :</b> ';
      const modeSel = document.createElement('select');
      modeSel.innerHTML = '<option value="foot" selected>Marche üö∂</option>' +
                          '<option value="bike">V√©lo üö≤</option>' +
                          '<option value="driving">Voiture üöó</option>';
      modeSel.onchange = () => setProfile(modeSel.value);
      modeBox.appendChild(modeSel);
      container.appendChild(modeBox);

      return container;
    };
    quickCtrl.addTo(map);

  </script>
</body>
</html>
