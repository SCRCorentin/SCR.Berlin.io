<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Carte ‚Äî Berlin</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <!-- LRM CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    :root { --radius: 12px; --shadow: 0 4px 16px rgba(0,0,0,.18); }
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* Bottom dock (mobile toolbar) */
    .dock {
      position: absolute;
      left: 8px; right: 8px;
      bottom: calc(8px + env(safe-area-inset-bottom, 0px));
      z-index: 1000;
      background: rgba(255,255,255,.96);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 8px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    .dock .row { display:flex; gap:8px; align-items:center; }
    .dock select, .dock button, .dock input[type="checkbox"] { font-size: 16px; }
    .dock select {
      flex:1;
      padding: 10px;
      border-radius: 10px; border: 1px solid #ddd; background: white;
    }
    .dock button {
      padding: 10px 12px;
      border-radius: 10px; border: 1px solid #ddd; background:white;
    }
    .dock label { font-size: 14px; }
    .dock .hint { font-size: 12px; color:#555; }

    .leaflet-control-geocoder { min-width: 220px; }
    @media (max-width: 420px) {
      .leaflet-control-geocoder { min-width: 170px; }
      .dock select, .dock button { font-size: 15px; }
    }

    /* Legend */
    .legend {
      position: absolute;
      left: 8px;
      top: calc(8px + env(safe-area-inset-top, 0px));
      z-index: 1000;
      background: rgba(255,255,255,.96);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 6px 8px;
      font-size: 13px;
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Legend -->
  <div class="legend leaflet-control">
    <div>ü™© autres lieux</div>
    <div>üíñ strip-clubs</div>
  </div>

  <!-- Bottom dock -->
  <div class="dock leaflet-control" id="dock">
    <div class="row">
      <button id="locateBtn" title="Ma position">üìç</button>
      <button id="undoBtn" title="Supprimer le dernier point">‚Ü©Ô∏è</button>
      <button id="clearBtn" title="Effacer l‚Äôitin√©raire">‚ùå</button>
      <label><input type="checkbox" id="tapToggle" checked /> Tap = poser un point</label>
    </div>
    <div class="row">
      <select id="modeSel" title="Mode">
        <option value="walking" selected>Marche üö∂</option>
        <option value="cycling">V√©lo üö≤</option>
        <option value="driving">Voiture üöó</option>
      </select>
      <select id="destSel" title="Itin√©raire vers">
        <option value="">Itin√©raire vers‚Ä¶</option>
      </select>
    </div>
    <div class="row hint">
      Conseil : utilisez la loupe pour chercher une adresse. La dur√©e s‚Äôajuste selon le mode choisi.
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <!-- LRM JS -->
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <!-- Geocoder JS -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // ---- Donn√©es ----
    const autres = [
      { nom: "Crack Bellemer", lat: 52.5075992, lon: 13.4547859, desc: "ok pour groupes" },
      { nom: "Ritter Butzke", lat: 52.5028492, lon: 13.4078816, desc: "ok pour groupes" },
      { nom: "Berghain", lat: 52.5110691, lon: 13.4429945, desc: "Meilleure bo√Æte du monde (difficile d'entrer)" },
      { nom: "Renate", lat: 52.505, lon: 13.454, desc: "Club" },
      { nom: "Klunkerkranich", lat: 52.482195, lon: 13.4318525, desc: "Bar rooftop" },
      { nom: "Bulbul Berlin", lat: 52.4994098, lon: 13.4242594, desc: "Lieu festif" },
      { nom: "Golden Gate", lat: 52.5159496, lon: 13.4170683, desc: "Club (underground)" },
      { nom: "MS Hoppetosse", lat: 52.4975353, lon: 13.4546997, desc: "Club sur un bateau" },
      { nom: "Tr√©sor Berlin", lat: 52.5107462, lon: 13.4193396, desc: "Club techno l√©gendaire" },
      { nom: "SchwuZ", lat: 52.4794165, lon: 13.4337682, desc: "Club LGBTQ, facile √† entrer" }
    ];

    const strips = [
      { nom: "Golden Dolls", lat: 52.5036206, lon: 13.3658569, desc: "Strip-club" },
      { nom: "Angels Berlin", lat: 52.5293175, lon: 13.4101599, desc: "Strip-club" },
      { nom: "Tutti Frutti Club", lat: 52.4933521, lon: 13.3869794, desc: "Strip-club" },
      { nom: "Chez Michelle", lat: 52.5027899, lon: 13.3370558, desc: "Gentlemen‚Äôs & Strip Club" },
      { nom: "Sin City", lat: 52.5057579, lon: 13.3044032, desc: "Tabledance" }
    ];

    // ---- Carte ----
    const map = L.map('map').setView([52.5076, 13.4], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    // Marqueurs ü™© (autres) - pins par d√©faut
    autres.forEach(l => {
      L.marker([l.lat, l.lon], { title: l.nom })
        .addTo(map)
        .bindPopup(`<b>ü™© ${l.nom}</b><br>${l.desc}`);
    });

    // Marqueurs üíñ (strips) - cercles roses bien visibles
    strips.forEach(l => {
      L.circleMarker([l.lat, l.lon], {
        radius: 9,
        color: '#ff1493', fillColor: '#ff69b4', fillOpacity: 0.9, weight: 2
      })
      .addTo(map)
      .bindPopup(`<b>üíñ ${l.nom}</b><br/>${l.desc}`);
    });

    // Geocoder (loupe)
    const geocoder = L.Control.geocoder({ defaultMarkGeocode: true, placeholder: "Chercher une adresse‚Ä¶" }).addTo(map);

    // Emp√™cher les clics √† travers les contr√¥les
    const dock = document.getElementById('dock');
    L.DomEvent.disableClickPropagation(dock);
    L.DomEvent.disableScrollPropagation(dock);
    setTimeout(() => {
      const gc = document.querySelector('.leaflet-control-geocoder');
      if (gc) {
        L.DomEvent.disableClickPropagation(gc);
        L.DomEvent.disableScrollPropagation(gc);
      }
    }, 0);

    // ---- Routing (walking/cycling/driving) ----
    let currentProfile = 'walking';
    const routerFactory = (profile) => L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1',
      profile
    });
    const formatter = new L.Routing.Formatter({ units: 'metric', language: 'fr' });

    const routingControl = L.Routing.control({
      router: routerFactory(currentProfile),
      routeWhileDragging: true,
      showAlternatives: true,
      collapsible: true,
      formatter,
      summaryTemplate: '<div><b>{name}</b><br><span id="lrm-mode">Mode: '+currentProfile+'</span><br>Distance: {distance}, Dur√©e: {time}</div>'
    }).addTo(map);

    function setProfile(profile){
      currentProfile = profile;
      routingControl.setRouter(routerFactory(currentProfile));
      const modeEl = document.getElementById('lrm-mode');
      if (modeEl) modeEl.textContent = 'Mode: ' + currentProfile;
      try { routingControl.route(); } catch(e) {}
    }

    // Menu destination = ü™© pour autres, üíñ pour strips
    const allOptions = [
      ...autres.map(l => ({ label: `ü™© ${l.nom}`, lat: l.lat, lon: l.lon })),
      ...strips.map(l => ({ label: `üíñ ${l.nom}`, lat: l.lat, lon: l.lon })),
    ].sort((a,b) => a.label.localeCompare(b.label, 'fr'));

    const destSel = document.getElementById('destSel');
    destSel.innerHTML = '<option value="">Itin√©raire vers‚Ä¶</option>' +
      allOptions.map(o => `<option value="${o.lat},${o.lon}">${o.label}</option>`).join('');

    destSel.addEventListener('change', () => {
      if (!destSel.value) return;
      const [lat, lon] = destSel.value.split(',').map(parseFloat);
      const dest = L.latLng(lat, lon);
      const wps = routingControl.getWaypoints();
      if (!wps[0].latLng) {
        routingControl.setWaypoints([map.getCenter(), dest]);
      } else {
        routingControl.setWaypoints([wps[0].latLng, dest]);
      }
    });

    // S√©lecteur de mode
    document.getElementById('modeSel').addEventListener('change', (e) => setProfile(e.target.value));

    // Tap-to-add toggle
    let tapEnabled = true;
    document.getElementById('tapToggle').addEventListener('change', (e) => tapEnabled = e.target.checked);

    // Clic carte pour poser points (prot√©g√© des contr√¥les)
    map.on('click', (e) => {
      if (!tapEnabled) return;
      if (e.originalEvent && e.originalEvent.target.closest && e.originalEvent.target.closest('.leaflet-control')) return;
      const wps = routingControl.getWaypoints();
      if (!wps[0].latLng) routingControl.setWaypoints([e.latlng]);
      else if (!wps[1].latLng) routingControl.setWaypoints([wps[0].latLng, e.latlng]);
      else routingControl.setWaypoints([wps[0].latLng, e.latlng]);
    });

    // Boutons
    document.getElementById('clearBtn').addEventListener('click', (e) => {
      e.preventDefault();
      routingControl.setWaypoints([]);
      destSel.value = "";
    });
    document.getElementById('undoBtn').addEventListener('click', (e) => {
      e.preventDefault();
      const wps = routingControl.getWaypoints();
      if (wps[1].latLng) routingControl.setWaypoints([wps[0].latLng]);
      else if (wps[0].latLng) routingControl.setWaypoints([]);
    });

    // Localisation (iOS/Safari-friendly)
    document.getElementById('locateBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (!('geolocation' in navigator)) return alert('G√©olocalisation non support√©e.');
      if (!window.isSecureContext) return alert('HTTPS requis pour la g√©olocalisation.');
      const opts = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const ll = [pos.coords.latitude, pos.coords.longitude];
          map.setView(ll, 15);
          L.circleMarker(ll, {radius:7, color:'#333', fillColor:'#3af', fillOpacity:0.9}).addTo(map).bindPopup('Vous √™tes ici').openPopup();
        },
        (err) => {
          if (err.code === 1) alert('Autorisez la localisation dans R√©glages > Safari > Localisation.');
          else if (err.code === 2) alert('Position indisponible. R√©essayez pr√®s d‚Äôune fen√™tre.');
          else alert('D√©lai d√©pass√©. R√©essayez.');
        },
        opts
      );
    });
  </script>
</body>
</html>
