<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Carte Clubs Berlin ‚Äî Mobile</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
  <!-- LRM CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    :root { --pad: 10px; --radius: 12px; --shadow: 0 4px 16px rgba(0,0,0,.18); }
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* Floating top-left block (Geocoder) */
    .toppad { position:absolute; top: env(safe-area-inset-top, 0px); left: 8px; right: 8px; z-index:1000; display:flex; gap:8px; pointer-events:none; }
    .chip { background: rgba(255,255,255,.96); border-radius: var(--radius); padding: 6px 10px; box-shadow: var(--shadow); pointer-events:auto; }
    .chip .title { font-weight:600; font-size: 14px; }

    /* Bottom dock (mobile toolbar) */
    .dock {
      position: absolute;
      left: 8px; right: 8px;
      bottom: calc(8px + env(safe-area-inset-bottom, 0px));
      z-index: 1000;
      background: rgba(255,255,255,.96);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 8px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    .dock .row { display:flex; gap:8px; align-items:center; }
    .dock select, .dock button, .dock input[type="checkbox"] {
      font-size: 16px;
    }
    .dock select {
      flex:1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: white;
    }
    .dock button {
      padding: 10px 12px;
      border-radius: 10px; border: 1px solid #ddd; background:white;
    }
    .dock label { font-size: 14px; }
    .dock .hint { font-size: 12px; color:#555; }

    .leaflet-control-geocoder {
      min-width: 240px;
    }

    /* Make sure controls don't steal too much space on small screens */
    @media (max-width: 420px) {
      .leaflet-control-geocoder { min-width: 180px; }
      .dock select, .dock button { font-size: 15px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="toppad">
    <div class="chip">
      <div class="title">Carte Clubs Berlin</div>
      <div style="font-size:12px">Recherche üîç, itin√©raires üö∂üö≤üöó</div>
    </div>
    <!-- Geocoder will render here (top-left by default) -->
  </div>

  <!-- Bottom dock -->
  <div class="dock leaflet-control" id="dock">
    <div class="row">
      <button id="locateBtn" title="Ma position">üìç</button>
      <button id="undoBtn" title="Supprimer le dernier point">‚Ü©Ô∏è</button>
      <button id="clearBtn" title="Effacer l‚Äôitin√©raire">‚ùå</button>
      <label><input type="checkbox" id="tapToggle" checked /> Tap = poser un point</label>
    </div>
    <div class="row">
      <select id="modeSel" title="Mode">
        <option value="foot" selected>Marche üö∂</option>
        <option value="bike">V√©lo üö≤</option>
        <option value="driving">Voiture üöó</option>
      </select>
      <select id="destSel" title="Itin√©raire vers">
        <option value="">Itin√©raire vers‚Ä¶</option>
      </select>
    </div>
    <div class="row hint">
      Conseils : utilisez la loupe pour chercher une adresse. La dur√©e s‚Äôajuste selon le mode choisi.
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <!-- LRM JS -->
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <!-- Geocoder JS -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // ---- Donn√©es ----
    const lieux = [
      { nom: "Crack Bellemer", lat: 52.5075992, lon: 13.4547859, desc: "ok pour groupes" },
      { nom: "Ritter Butzke", lat: 52.5028492, lon: 13.4078816, desc: "ok pour groupes" },
      { nom: "Berghain", lat: 52.5110691, lon: 13.4429945, desc: "Meilleure bo√Æte du monde (difficile d'entrer)" },
      { nom: "Renate", lat: 52.505, lon: 13.454, desc: "Club" },
      { nom: "Klunkerkranich", lat: 52.482195, lon: 13.4318525, desc: "Bar rooftop" },
      { nom: "Bulbul Berlin", lat: 52.4994098, lon: 13.4242594, desc: "Lieu festif" },
      { nom: "Golden Gate", lat: 52.5159496, lon: 13.4170683, desc: "Club (underground)" },
      { nom: "MS Hoppetosse", lat: 52.4975353, lon: 13.4546997, desc: "Club sur un bateau" },
      { nom: "Tr√©sor Berlin", lat: 52.5107462, lon: 13.4193396, desc: "Club techno l√©gendaire" },
      { nom: "SchwuZ", lat: 52.4794165, lon: 13.4337682, desc: "Club LGBTQ, facile √† entrer" }
    ];

    // ---- Carte ----
    const map = L.map('map').setView([52.5076, 13.4], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

    // Place markers
    lieux.forEach(l => L.marker([l.lat, l.lon], { title: l.nom }).addTo(map).bindPopup(`<b>${l.nom}</b><br>${l.desc}`));

    // Geocoder
    const geocoder = L.Control.geocoder({ defaultMarkGeocode: true, placeholder: "Chercher une adresse‚Ä¶" }).addTo(map);

    // Prevent clicks on controls from creating points
    const dock = document.getElementById('dock');
    L.DomEvent.disableClickPropagation(dock);
    L.DomEvent.disableScrollPropagation(dock);
    setTimeout(() => {
      const gc = document.querySelector('.leaflet-control-geocoder');
      if (gc) {
        L.DomEvent.disableClickPropagation(gc);
        L.DomEvent.disableScrollPropagation(gc);
      }
    }, 0);

    // ---- Routing ----
    let currentProfile = 'foot'; // 'foot' | 'bike' | 'driving'
    const routerFactory = (profile) => L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile });
    const formatter = new L.Routing.Formatter({ units: 'metric', language: 'fr' });

    const routingControl = L.Routing.control({
      router: routerFactory(currentProfile),
      routeWhileDragging: true,
      showAlternatives: true,
      collapsible: true,
      formatter,
      summaryTemplate: '<div><b>{name}</b><br><span id="lrm-mode">Mode: '+currentProfile+'</span><br>Distance: {distance}, Dur√©e: {time}</div>'
    }).addTo(map);

    function setProfile(profile){
      currentProfile = profile;
      routingControl.setRouter(routerFactory(currentProfile));
      const modeEl = document.getElementById('lrm-mode');
      if (modeEl) modeEl.textContent = 'Mode: ' + currentProfile;
      try { routingControl.route(); } catch(e) {}
    }

    // Destinations list
    const destSel = document.getElementById('destSel');
    destSel.innerHTML = '<option value="">Itin√©raire vers‚Ä¶</option>' + lieux.map(l => `<option value="${l.lat},${l.lon}">${l.nom}</option>`).join('');

    destSel.addEventListener('change', () => {
      if (!destSel.value) return;
      const [lat, lon] = destSel.value.split(',').map(parseFloat);
      const dest = L.latLng(lat, lon);
      const wps = routingControl.getWaypoints();
      if (!wps[0].latLng) {
        routingControl.setWaypoints([map.getCenter(), dest]);
      } else {
        routingControl.setWaypoints([wps[0].latLng, dest]);
      }
    });

    // Mode selector
    document.getElementById('modeSel').addEventListener('change', (e) => setProfile(e.target.value));

    // Tap-to-add toggle
    let tapEnabled = true;
    document.getElementById('tapToggle').addEventListener('change', (e) => tapEnabled = e.target.checked);

    // Map click to set waypoints (only if toggle ON)
    map.on('click', (e) => {
      if (!tapEnabled) return;
      if (e.originalEvent && e.originalEvent.target.closest && e.originalEvent.target.closest('.leaflet-control')) return;
      const wps = routingControl.getWaypoints();
      if (!wps[0].latLng) routingControl.setWaypoints([e.latlng]);
      else if (!wps[1].latLng) routingControl.setWaypoints([wps[0].latLng, e.latlng]);
      else routingControl.setWaypoints([wps[0].latLng, e.latlng]);
    });

    // Buttons
    document.getElementById('clearBtn').addEventListener('click', (e) => {
      e.preventDefault();
      routingControl.setWaypoints([]);
      destSel.value = "";
    });
    document.getElementById('undoBtn').addEventListener('click', (e) => {
      e.preventDefault();
      const wps = routingControl.getWaypoints();
      if (wps[1].latLng) routingControl.setWaypoints([wps[0].latLng]);
      else if (wps[0].latLng) routingControl.setWaypoints([]);
    });
    document.getElementById('locateBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (!navigator.geolocation) return alert('G√©olocalisation non support√©e.');
      navigator.geolocation.getCurrentPosition(pos => {
        const ll = [pos.coords.latitude, pos.coords.longitude];
        map.setView(ll, 15);
        L.circleMarker(ll).addTo(map).bindPopup('Vous √™tes ici').openPopup();
      }, () => alert('Impossible de r√©cup√©rer votre position.'));
    });
  </script>
</body>
</html>
